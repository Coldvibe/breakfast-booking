<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ‚Äî Zack & Snack</title>
  <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <div class="logo egg-logo">
        <svg viewBox="0 0 64 64" width="28" height="28" aria-hidden="true">
          <path d="M32 6 C20 6 10 18 10 30 c0 12 10 22 22 22 s22-10 22-22 C54 18 44 6 32 6Z"
                fill="#ffffff" opacity="0.95"/>
          <circle cx="32" cy="32" r="8" fill="#facc15"/>
        </svg>
      </div>
      <div>
        <h1>Dashboard Admin</h1>
        <p>Centre de contr√¥le Zack & Snack</p>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <a class="btn secondary" href="/">‚Üê Retour √† l‚Äôaccueil</a>

      <form method="post" action="/admin/logout">
        <button class="btn danger" type="submit">Se d√©connecter</button>
      </form>
    </div>
  </div>

  {% if flash %}
    <div class="card" style="border-color:rgba(59,130,246,.4)">
      <strong>{{ flash["message"] }}</strong>
    </div>
  {% endif %}

  {# --- Snapshot "demain" envoy√© par admin.py --- #}
  {% set e = snapshot["event"] %}
  {% set k = snapshot["kpis"] %}
  {% set totals = snapshot["totals"] %}
  {% set reservations = snapshot["reservations"] %}
  {% set offers = snapshot["offers"] %}

  <!-- COCKPIT DEMAIN -->
  <div class="card">
    <h2 class="card-title">üìÖ Demain</h2>

    {% if not e %}
      <div class="muted">Impossible de charger l‚Äô√©v√©nement de demain.</div>
    {% else %}

      <!-- Status badges -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <div class="badge">
          Date : <b>{{ e["date"] }}</b>
        </div>

        {% if e["is_planned"] %}
          <div class="badge">Petit-d√©jeuner : <b>Pr√©vu</b></div>
        {% else %}
          <div class="badge badge-danger">Petit-d√©jeuner : <b>Pas pr√©vu</b></div>
        {% endif %}

        {% if e["open"] %}
          <div class="badge">R√©servations : <b>Ouvertes</b></div>
        {% else %}
          <div class="badge badge-danger">R√©servations : <b>Ferm√©es</b></div>
        {% endif %}
      </div>
      {# --- Alertes / priorit√©s (check rapide admin) --- #}
      {% set alerts = [] %}

      {% if not e["is_planned"] %}
        {% set _ = alerts.append("Petit-d√©jeuner non pr√©vu : personne ne pourra r√©server tant que ce n‚Äôest pas activ√©.") %}
      {% endif %}

      {% if e["is_planned"] and (not e["open"]) %}
        {% set _ = alerts.append("R√©servations ferm√©es : pense √† les ouvrir si tu veux que les agents r√©servent.") %}
      {% endif %}

      {% if k["mains_count"] == 0 and k["sides_count"] == 0 %}
        {% set _ = alerts.append("Aucune offre d√©finie : ajoute au moins 1 plat ou 1 accompagnement.") %}
      {% elif k["mains_count"] == 0 %}
        {% set _ = alerts.append("Aucun plat (MAIN) d√©fini : les gens ne pourront choisir que des accompagnements.") %}
      {% endif %}

      {% if k["working_agents_count"] == 0 %}
        {% set _ = alerts.append("Aucun agent s√©lectionn√© pour demain : impossible de g√©n√©rer des liens WhatsApp utiles.") %}
      {% endif %}

      {% if alerts|length > 0 %}
        <div class="notice" style="margin-top:12px">
          <div class="notice-icon">‚ö†Ô∏è</div>
          <div class="notice-body">
            <div class="notice-title">Priorit√©s</div>
            <ul style="margin:8px 0 0 18px">
              {% for a in alerts %}
                <li class="notice-text">{{ a }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      {% else %}
        <div class="notice" style="margin-top:12px;border-color:rgba(34,197,94,.35)">
          <div class="notice-icon">‚úÖ</div>
          <div class="notice-body">
            <div class="notice-title">Tout est pr√™t</div>
            <div class="notice-text">Offres OK, agents OK, et l‚Äô√©v√©nement est configur√©.</div>
          </div>
        </div>
      {% endif %}

      <hr class="hr">

      <!-- KPI row -->
      <div class="kpis">
        <div class="kpi">
          <b>{{ k["reservations_count"] }}</b>
          <span>r√©servation(s)</span>
        </div>
        <div class="kpi">
          <b>{{ k["working_agents_count"] }}</b>
          <span>agent(s) shift</span>
        </div>
        <div class="kpi">
          <b>{{ k["mains_count"] }}</b>
          <span>plat(s)</span>
        </div>
        <div class="kpi">
          <b>{{ k["sides_count"] }}</b>
          <span>accompagnement(s)</span>
        </div>
      </div>

      <!-- Actions -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
        <form method="post" action="/admin/toggle">
          <button class="btn secondary" type="submit">
            {{ "Fermer les r√©servations" if e["open"] else "Ouvrir les r√©servations" }}
          </button>
        </form>

        <form method="post" action="/admin/toggle-planned">
          <button class="btn secondary" type="submit">
            {{ "D√©sactiver petit-d√©jeuner demain" if e["is_planned"] else "Activer petit-d√©jeuner demain" }}
          </button>
        </form>

        <a class="btn" href="/admin/offers">üç≥ G√©rer offres</a>
        <a class="btn" href="/admin/shifts">üìç G√©rer agents de demain</a>
      </div>

    {% endif %}
  </div>

  <!-- TOTAUX -->
  <div class="card">
    <h2 class="card-title">üì¶ Totaux (pr√©pa)</h2>

    {% if not e %}
      <div class="muted">‚Äî</div>
    {% else %}

      <div class="grid">
        <div class="card">
          <h3>Plats</h3>
          {% if totals["mains"] and totals["mains"]|length > 0 %}
            <div class="list">
              {% for label, qty in totals["mains"].items() %}
                <div class="item">
                  <div class="name">{{ label }}</div>
                  <div class="meta"><b>{{ qty }}</b></div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="muted">Aucun plat r√©serv√© pour l‚Äôinstant.</div>
          {% endif %}
        </div>

        <div class="card">
          <h3>Accompagnements</h3>
          {% if totals["sides"] and totals["sides"]|length > 0 %}
            <div class="list">
              {% for label, qty in totals["sides"].items() %}
                <div class="item">
                  <div class="name">{{ label }}</div>
                  <div class="meta"><b>{{ qty }}</b></div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="muted">Aucun accompagnement r√©serv√© pour l‚Äôinstant.</div>
          {% endif %}
        </div>
      </div>

    {% endif %}
  </div>

  <!-- R√âSERVATIONS -->
  <div class="card">
    <h2 class="card-title">üßæ Commandes / R√©servations</h2>

    {% if not e %}
      <div class="muted">‚Äî</div>
    {% else %}

      {% if reservations|length == 0 %}
        <div class="muted">Aucune r√©servation pour l‚Äôinstant.</div>
      {% else %}
        <div class="list">
          {% for r in reservations %}
            <div class="item">
              <div class="name">{{ r["name"] }}</div>

              <div class="meta" style="margin-top:6px">
                {% if r["lines"] and (r["lines"]|length > 0) %}
                  <div class="line-badges">
                    {% for l in r["lines"] %}
                      <span class="line-badge {% if l['type']=='MAIN' %}main{% else %}side{% endif %}">
                        <span class="qty">{{ l["qty"] }}</span>
                        {{ l["label"] }}
                      </span>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="muted">Choix : ‚Äî</div>
                {% endif %}

                <div style="margin-top:10px">
                  <span class="muted">Ram√®ne :</span>
                  {{ r["bring"] if r["bring"] else "‚Äî" }}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

    {% endif %}
  </div>

  <!-- RACCOURCIS -->
  <div class="card">
    <h2 class="card-title">üß≠ Acc√®s rapide</h2>
    <div class="grid">

      <div class="card">
        <h3>üë• Agents</h3>
        <div class="muted">Gestion compl√®te des membres.</div>
        <div style="margin-top:12px">
          <a class="btn secondary" href="/admin/agents">Ouvrir</a>
        </div>
      </div>

      <div class="card">
        <h3>ü•ò Plats / Recettes</h3>
        <div class="muted">Cr√©er et g√©rer les pr√©parations propos√©es.</div>
        <div style="margin-top:12px">
          <a class="btn secondary" href="/admin/recipes">Ouvrir</a>
        </div>
      </div>

      <div class="card">
        <h3>ü•ñ Aliments</h3>
        <div class="muted">Accompagnements & unit√©s.</div>
        <div style="margin-top:12px">
          <a class="btn secondary" href="/admin/foods">Ouvrir</a>
        </div>
      </div>

    </div>
  </div>

</div>
</body>
</html>
